# This is a basic workflow to help you get started with Actions

name: Managing NGINX configs with Github and Github Actions

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      # Runs a single command using the runners shell
      #- name: Run a one-line script
      #  run: curl --location "https://${{ vars.NMS_HOSTNAME }}/api/platform/v1/systems/45b85ba0-bedb-31a4-94c8-263855521496/instances/bbe4badb-e978-5cd9-ab1d-bc5be2fb228c/config" --header "accept: application/json" --header "Authorization: Basic ${NMS_LOGIN}"

      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          export NMS_LOGIN=`echo -n "${{ secrets.NMS_USERNAME }}:${{ secrets.NMS_PASSWORD }}" | base64`
          export NMS_TIMESTAMP=`date -u +"%Y-%m-%dT%H:%M:%SZ"`
          curl --location 'https://${{ vars.NMS_HOSTNAME }}/api/platform/v1/systems/45b85ba0-bedb-31a4-94c8-263855521496/instances/bbe4badb-e978-5cd9-ab1d-bc5be2fb228c/config' --header "accept: application/json" --header "Authorization: Basic ${NMS_LOGIN}" --header 'Content-Type: application/json' --data '{"configFiles": {"rootDir": "/etc/nginx","files": [{"contents": "CnVzZXIgIG5naW54Owp3b3JrZXJfcHJvY2Vzc2VzICBhdXRvOwpsb2FkX21vZHVsZSBtb2R1bGVzL25neF9odHRwX2FwcF9wcm90ZWN0X21vZHVsZS5zbzsKZXJyb3JfbG9nICAvdmFyL2xvZy9uZ2lueC9lcnJvci5sb2cgbm90aWNlOwpwaWQgICAgICAgIC92YXIvcnVuL25naW54LnBpZDsKCmV2ZW50cyB7CiAgICB3b3JrZXJfY29ubmVjdGlvbnMgIDEwMjQ7Cn0KCmh0dHAgewogICAgaW5jbHVkZSAgICAgICAvZXRjL25naW54L21pbWUudHlwZXM7CiAgICBkZWZhdWx0X3R5cGUgIGFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbTsKCiAgICBsb2dfZm9ybWF0ICBtYWluICAnJHJlbW90ZV9hZGRyIC0gJHJlbW90ZV91c2VyIFskdGltZV9sb2NhbF0gIiRyZXF1ZXN0IiAnCiAgICAgICAgICAgICAgICAgICckc3RhdHVzICRib2R5X2J5dGVzX3NlbnQgIiRodHRwX3JlZmVyZXIiICcKICAgICAgICAgICAgICAgICAgJyIkaHR0cF91c2VyX2FnZW50IiAiJGh0dHBfeF9mb3J3YXJkZWRfZm9yIiAnCiAgICAgICAgICAgICAgICAgICciJGJ5dGVzX3NlbnQiICIkcmVxdWVzdF9sZW5ndGgiICIkcmVxdWVzdF90aW1lIiAnCiAgICAgICAgICAgICAgICAgICciJGd6aXBfcmF0aW8iICRzZXJ2ZXJfcHJvdG9jb2wgJzsKCiAgICBhY2Nlc3NfbG9nICAvdmFyL2xvZy9uZ2lueC9hY2Nlc3MubG9nICBtYWluOwoKICAgIHNlbmRmaWxlICAgICAgICBvbjsKICAgICN0Y3Bfbm9wdXNoICAgICBvbjsKCiAgICBrZWVwYWxpdmVfdGltZW91dCAgNjU7CgogICAgcHJveHlfY2FjaGVfcGF0aCAvZGF0YS9uZ2lueC9jYWNoZV9iYWNrZW5kMSBrZXlzX3pvbmU9Y2FjaGVfYmFja2VuZDE6MTBtOwogICAgcHJveHlfY2FjaGVfcGF0aCAvZGF0YS9uZ2lueC9jYWNoZV9iYWNrZW5kMiBrZXlzX3pvbmU9Y2FjaGVfYmFja2VuZDI6MTBtOwogCiAgICAjZ3ppcCAgb247CgogICAgc2VydmVyIHsKICAgICAgICBsaXN0ZW4gMTAuMS4xLjY6ODA4MDsKICAgICAgICBsb2NhdGlvbiAvIHsKICAgICAgICAgICBwcm94eV9wYXNzIGh0dHA6Ly9uZ2lueDsKICAgICAgICAgICAgI2FwcF9wcm90ZWN0X2VuYWJsZSBvbjsKICAgICAgICAgICAgI2FwcF9wcm90ZWN0X3BvbGljeV9maWxlIC9ldGMvbm1zL2RlZmF1bHQtZW5mb3JjZW1lbnQ2LnRnegogICAgICAgICAgICAjYXBwX3Byb3RlY3Rfc2VjdXJpdHlfbG9nX2VuYWJsZSBvbjsKICAgICAgICAgICAgI2FwcF9wcm90ZWN0X3NlY3VyaXR5X2xvZyAvZXRjL25tcy9zZWNvcHNfZGFzaGJvYXJkLnRneiBzeXNsb2c6c2VydmVyPTEyNy4wLjAuMTo1MTQ7ICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIGxvY2F0aW9uIC8yIHsKICAgICAgICAgICBwcm94eV9wYXNzIGh0dHA6Ly9uZ2lueDsKICAgICAgICAgICAjYXBwX3Byb3RlY3RfZW5hYmxlIG9uOwogICAgICAgICAgICNhcHBfcHJvdGVjdF9wb2xpY3lfZmlsZSAvZXRjL25tcy9pZ25vcmUteHNzLnRnejsKICAgICAgICAgICAjYXBwX3Byb3RlY3Rfc2VjdXJpdHlfbG9nX2VuYWJsZSBvbjsKICAgICAgICAgICAjYXBwX3Byb3RlY3Rfc2VjdXJpdHlfbG9nIC9ldGMvbm1zL3NlY29wc19kYXNoYm9hcmQudGd6IHN5c2xvZzpzZXJ2ZXI9MTI3LjAuMC4xOjUxNDsKICAgICAgICAgfQogICAgfQogICAgICAgIAogICAgc2VydmVyIHsKICAgICAgICBsaXN0ZW4gOTA5MTsKICAgICAgICByZXR1cm4gMjAwICJoZWxsbyBmcm9tIGh0dHAgd29ya2xvYWQgMSBcbiI7CiAgICB9ICAgICAKICAgIHNlcnZlciB7CiAgICAgICAgbGlzdGVuIDkwOTI7CiAgICAgICAgcmV0dXJuIDIwMCAiaGVsbG8gZnJvbSBodHRwIHdvcmtsb2FkIDIgXG4iOwogICAgfQogICAgc2VydmVyIHsKICAgICAgICBsaXN0ZW4gOTA5MzsKICAgICAgICByZXR1cm4gMjAwICJoZWxsbyBmcm9tIHN0cmVhbSB3b3JrbG9hZCAxIFxuIjsKICAgIH0KCiAgICB1cHN0cmVhbSBuZ2lueCB7CiAgICAgICAgc2VydmVyIDEyNy4wLjAuMTozMDAyOwogICAgfQogCiAgICB1cHN0cmVhbSBuZ2lueDEgewogICAgICAgIHNlcnZlciAxMjcuMC4wLjE6OTA5MTsKICAgICAgICB6b25lIG15X2JhY2tlbmQxIDEwMDAwMDA7CiAgICAgICAga2VlcGFsaXZlIDMyOwogICAgICAgIHF1ZXVlIDEwOwogICAgfQogICAgdXBzdHJlYW0gbmdpbngyIHsKICAgICAgICBzZXJ2ZXIgMTI3LjAuMC4xOjkwOTI7CiAgICAgICAgem9uZSBteV9iYWNrZW5kMiAxMDAwMDAwOwogICAgICAgIGtlZXBhbGl2ZSAzMjsKICAgICAgICBxdWV1ZSAyMDsKICAgIH0KIAogICAgc2VydmVyIHsKICAgICAgICBzdGF0dXNfem9uZSBteV9mcm9udGVuZDE7CiAgICAgICAgbGlzdGVuIDEyNy4wLjAuMTo4MDgxOwogICAgICAgIGxvY2F0aW9uIC9mcm9udGVuZDEgewogICAgICAgICAgICBwcm94eV9wYXNzIGh0dHA6Ly9uZ2lueDE7CiAgICAgICAgICAgIHByb3h5X2NhY2hlIGNhY2hlX2JhY2tlbmQxOwogICAgICAgICAgICBzdGF0dXNfem9uZSBteV9sb2NhdGlvbl96b25lOwogICAgICAgIH0KICAgIH0KICAgIHNlcnZlciB7CiAgICAgICAgc3RhdHVzX3pvbmUgbXlfZnJvbnRlbmQyOwogICAgICAgIGxpc3RlbiAxMjcuMC4wLjE6ODA4MjsKICAgICAgICBsb2NhdGlvbiAvZnJvbnRlbmQyIHsKICAgICAgICAgICAgcHJveHlfcGFzcyBodHRwOi8vbmdpbngyOwogICAgICAgICAgICBwcm94eV9jYWNoZSBjYWNoZV9iYWNrZW5kMjsKICAgICAgICAgICAgc3RhdHVzX3pvbmUgbXlfbG9jYXRpb25fem9uZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIGluY2x1ZGUgL2V0Yy9uZ2lueC9jb25mLmQvKi5jb25mOwoKICAgIHNlcnZlciB7CiAgICAgICAgbGlzdGVuIDEyNy4wLjAuMTo5MDkwOwogICAgICAgIGxvY2F0aW9uIC9hcGkgewogICAgICAgICAgICBhcGkgd3JpdGU9b247CiAgICAgICAgICAgIGFsbG93IDEyNy4wLjAuMTsKICAgICAgICAgICAgZGVueSBhbGw7CiAgICAgICAgfQogICAgfQp9CgpzdHJlYW0gewogICAgIyBFeGFtcGxlIGNvbmZpZ3VyYXRpb24gZm9yIFRDUCBsb2FkIGJhbGFuY2luZwogCiAgICB1cHN0cmVhbSBuZ2lueDMgewogICAgICAgIHpvbmUgbXlfc3RyZWFtX2JhY2tlbmQgNjRrOwogICAgICAgIHNlcnZlciAxMjcuMC4wLjE6OTA5MzsKCiAgICB9CiAKICAgIGxvZ19mb3JtYXQgYmFzaWMgJyRyZW1vdGVfYWRkciBbJHRpbWVfbG9jYWxdICcKICAgICAgICAgICAgICAgICAgICAgJyRwcm90b2NvbCAkc3RhdHVzICRieXRlc19zZW50ICRieXRlc19yZWNlaXZlZCAnCiAgICAgICAgICAgICAgICAgICAgICckc2Vzc2lvbl90aW1lJzsKICAgIGFjY2Vzc19sb2cgL3Zhci9sb2cvbmdpbngvYWNjZXNzLmxvZyBiYXNpYzsKIAogICAgc2VydmVyIHsKICAgICAgICBsaXN0ZW4gODA4MzsKICAgICAgICBwcm94eV9wYXNzIG5naW54MzsKICAgICAgICBzdGF0dXNfem9uZSB0Y3Bfc3RyZWFtX3NlcnZlcjsKCiAgICB9Cn0K","name": "/etc/nginx/nginx.conf"}]},"updateTime": "`date -u +"%Y-%m-%dT%H:%M:%SZ"`"}'
