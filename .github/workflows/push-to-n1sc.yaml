
name: Managing NGINX configs with Github and Github Actions

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
      
      - name: Set environment variable for XC Bearer Token credentials
        run: echo "XC_BEARER_TOKEN=`echo -n "${{ secrets.XC_BEARER_TOKEN }}`" >> $GITHUB_ENV
        
      - name: Set environment variable for N1SC API timestamp
        run: echo "N1SC_TIMESTAMP=`date -u +"%Y-%m-%dT%H:%M:%SZ"`" >> $GITHUB_ENV

      - name: timestamp the config
        run: date | cat - app-nyc-01/etc/nginx/nginx.conf > temp && mv temp app-nyc-01/etc/nginx/nginx.conf

      - name: Set environment variable for base64 encoded config file
        run: echo "NGINX_CONF_CONFIG_FILE=`cat app-nyc-01/etc/nginx/nginx.conf | base64 -w 0`" >> $GITHUB_ENV

      - name: Set environment variable for base64 encoded config file
        run: echo "MIME_TYPES_CONFIG_FILE=`cat app-nyc-01/etc/nginx/mime.types | base64 -w 0`" >> $GITHUB_ENV

      - name: Set environment variable for base64 encoded config file
        run: echo "DEFAULT_CONF_CONFIG_FILE=`cat app-nyc-01/etc/nginx/conf.d/default.conf | base64 -w 0`" >> $GITHUB_ENV

      - name: Set environment variable for base64 encoded config file
        run: echo "SSL_CERT=`cat app-sfo-01/etc/nginx/ssl/expiring.nginx.com.crt | base64 -w 0`" >> $GITHUB_ENV

      - name: Set environment variable for base64 encoded config file
        run: echo "SSL_KEY=`cat app-sfo-01/etc/nginx/ssl/expiring.nginx.com.key | base64 -w 0`" >> $GITHUB_ENV

      - name: API call to NGINX One Saas Console
        run: |
          curl --location 'https://${{ vars.N1SC_HOSTNAME }}${{ vars.N1SC_API_PATH }}/${{ vars.N1SC_NAMESPACE }}/instances/summary' -H 'Authorization: Bearer ${{ secrets.XC_BEARER_TOKEN }}'

      - name: API call to NGINX One Saas Console
        run: |
          curl -X PUT --location 'https://nginxone-team.staging.volterra.us/api/nginx/one/namespaces/default/instances/inst_23xYZTyZSpqa5UNi-eFcyw/config' -H 'Authorization: Bearer APIToken KLNLGO5l+ls8ePR41QiwTjFc9OU=' --data '{ "aux": [], "conf_path": "/etc/nginx/nginx.conf", "configs": [ { "files": [ { "contents": "${{ env.NGINX_CONF_CONFIG_FILE }}", "mtime": "1970-01-01T00:00:00Z", "name": "nginx.conf", "size": 2756 }, { "contents": "CnR5cGVzIHsKICAgIHRleHQvaHRtbCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sIGh0bSBzaHRtbDsKICAgIHRleHQvY3NzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjc3M7CiAgICB0ZXh0L3htbCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1sOwogICAgaW1hZ2UvZ2lmICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdpZjsKICAgIGltYWdlL2pwZWcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcGVnIGpwZzsKICAgIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQgICAgICAgICAgICAgICAgICAgICAgICAgICBqczsKICAgIGFwcGxpY2F0aW9uL2F0b20reG1sICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdG9tOwogICAgYXBwbGljYXRpb24vcnNzK3htbCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJzczsKCiAgICB0ZXh0L21hdGhtbCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW1sOwogICAgdGV4dC9wbGFpbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4dDsKICAgIHRleHQvdm5kLnN1bi5qMm1lLmFwcC1kZXNjcmlwdG9yICAgICAgICAgICAgICAgICBqYWQ7CiAgICB0ZXh0L3ZuZC53YXAud21sICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd21sOwogICAgdGV4dC94LWNvbXBvbmVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0YzsKCiAgICBpbWFnZS9wbmcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG5nOwogICAgaW1hZ2Uvc3ZnK3htbCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN2ZyBzdmd6OwogICAgaW1hZ2UvdGlmZiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpZiB0aWZmOwogICAgaW1hZ2Uvdm5kLndhcC53Ym1wICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdibXA7CiAgICBpbWFnZS93ZWJwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2VicDsKICAgIGltYWdlL3gtaWNvbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY287CiAgICBpbWFnZS94LWpuZyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgam5nOwogICAgaW1hZ2UveC1tcy1ibXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJtcDsKCiAgICBmb250L3dvZmYgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29mZjsKICAgIGZvbnQvd29mZjIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b2ZmMjsKCiAgICBhcHBsaWNhdGlvbi9qYXZhLWFyY2hpdmUgICAgICAgICAgICAgICAgICAgICAgICAgamFyIHdhciBlYXI7CiAgICBhcHBsaWNhdGlvbi9qc29uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganNvbjsKICAgIGFwcGxpY2F0aW9uL21hYy1iaW5oZXg0MCAgICAgICAgICAgICAgICAgICAgICAgICBocXg7CiAgICBhcHBsaWNhdGlvbi9tc3dvcmQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jOwogICAgYXBwbGljYXRpb24vcGRmICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBkZjsKICAgIGFwcGxpY2F0aW9uL3Bvc3RzY3JpcHQgICAgICAgICAgICAgICAgICAgICAgICAgICBwcyBlcHMgYWk7CiAgICBhcHBsaWNhdGlvbi9ydGYgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnRmOwogICAgYXBwbGljYXRpb24vdm5kLmFwcGxlLm1wZWd1cmwgICAgICAgICAgICAgICAgICAgIG0zdTg7CiAgICBhcHBsaWNhdGlvbi92bmQuZ29vZ2xlLWVhcnRoLmttbCt4bWwgICAgICAgICAgICAga21sOwogICAgYXBwbGljYXRpb24vdm5kLmdvb2dsZS1lYXJ0aC5rbXogICAgICAgICAgICAgICAgIGttejsKICAgIGFwcGxpY2F0aW9uL3ZuZC5tcy1leGNlbCAgICAgICAgICAgICAgICAgICAgICAgICB4bHM7CiAgICBhcHBsaWNhdGlvbi92bmQubXMtZm9udG9iamVjdCAgICAgICAgICAgICAgICAgICAgZW90OwogICAgYXBwbGljYXRpb24vdm5kLm1zLXBvd2VycG9pbnQgICAgICAgICAgICAgICAgICAgIHBwdDsKICAgIGFwcGxpY2F0aW9uL3ZuZC5vYXNpcy5vcGVuZG9jdW1lbnQuZ3JhcGhpY3MgICAgICBvZGc7CiAgICBhcHBsaWNhdGlvbi92bmQub2FzaXMub3BlbmRvY3VtZW50LnByZXNlbnRhdGlvbiAgb2RwOwogICAgYXBwbGljYXRpb24vdm5kLm9hc2lzLm9wZW5kb2N1bWVudC5zcHJlYWRzaGVldCAgIG9kczsKICAgIGFwcGxpY2F0aW9uL3ZuZC5vYXNpcy5vcGVuZG9jdW1lbnQudGV4dCAgICAgICAgICBvZHQ7CiAgICBhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQucHJlc2VudGF0aW9ubWwucHJlc2VudGF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHB0eDsKICAgIGFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGxzeDsKICAgIGFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC53b3JkcHJvY2Vzc2luZ21sLmRvY3VtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jeDsKICAgIGFwcGxpY2F0aW9uL3ZuZC53YXAud21sYyAgICAgICAgICAgICAgICAgICAgICAgICB3bWxjOwogICAgYXBwbGljYXRpb24vd2FzbSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhc207CiAgICBhcHBsaWNhdGlvbi94LTd6LWNvbXByZXNzZWQgICAgICAgICAgICAgICAgICAgICAgN3o7CiAgICBhcHBsaWNhdGlvbi94LWNvY29hICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2NvOwogICAgYXBwbGljYXRpb24veC1qYXZhLWFyY2hpdmUtZGlmZiAgICAgICAgICAgICAgICAgIGphcmRpZmY7CiAgICBhcHBsaWNhdGlvbi94LWphdmEtam5scC1maWxlICAgICAgICAgICAgICAgICAgICAgam5scDsKICAgIGFwcGxpY2F0aW9uL3gtbWFrZXNlbGYgICAgICAgICAgICAgICAgICAgICAgICAgICBydW47CiAgICBhcHBsaWNhdGlvbi94LXBlcmwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGwgcG07CiAgICBhcHBsaWNhdGlvbi94LXBpbG90ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJjIHBkYjsKICAgIGFwcGxpY2F0aW9uL3gtcmFyLWNvbXByZXNzZWQgICAgICAgICAgICAgICAgICAgICByYXI7CiAgICBhcHBsaWNhdGlvbi94LXJlZGhhdC1wYWNrYWdlLW1hbmFnZXIgICAgICAgICAgICAgcnBtOwogICAgYXBwbGljYXRpb24veC1zZWEgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlYTsKICAgIGFwcGxpY2F0aW9uL3gtc2hvY2t3YXZlLWZsYXNoICAgICAgICAgICAgICAgICAgICBzd2Y7CiAgICBhcHBsaWNhdGlvbi94LXN0dWZmaXQgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l0OwogICAgYXBwbGljYXRpb24veC10Y2wgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRjbCB0azsKICAgIGFwcGxpY2F0aW9uL3gteDUwOS1jYS1jZXJ0ICAgICAgICAgICAgICAgICAgICAgICBkZXIgcGVtIGNydDsKICAgIGFwcGxpY2F0aW9uL3gteHBpbnN0YWxsICAgICAgICAgICAgICAgICAgICAgICAgICB4cGk7CiAgICBhcHBsaWNhdGlvbi94aHRtbCt4bWwgICAgICAgICAgICAgICAgICAgICAgICAgICAgeGh0bWw7CiAgICBhcHBsaWNhdGlvbi94c3BmK3htbCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeHNwZjsKICAgIGFwcGxpY2F0aW9uL3ppcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB6aXA7CgogICAgYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtICAgICAgICAgICAgICAgICAgICAgICAgIGJpbiBleGUgZGxsOwogICAgYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtICAgICAgICAgICAgICAgICAgICAgICAgIGRlYjsKICAgIGFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSAgICAgICAgICAgICAgICAgICAgICAgICBkbWc7CiAgICBhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0gICAgICAgICAgICAgICAgICAgICAgICAgaXNvIGltZzsKICAgIGFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSAgICAgICAgICAgICAgICAgICAgICAgICBtc2kgbXNwIG1zbTsKCiAgICBhdWRpby9taWRpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWlkIG1pZGkga2FyOwogICAgYXVkaW8vbXBlZyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1wMzsKICAgIGF1ZGlvL29nZyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZ2c7CiAgICBhdWRpby94LW00YSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbTRhOwogICAgYXVkaW8veC1yZWFsYXVkaW8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhOwoKICAgIHZpZGVvLzNncHAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAzZ3BwIDNncDsKICAgIHZpZGVvL21wMnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0czsKICAgIHZpZGVvL21wNCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtcDQ7CiAgICB2aWRlby9tcGVnICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXBlZyBtcGc7CiAgICB2aWRlby9xdWlja3RpbWUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW92OwogICAgdmlkZW8vd2VibSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdlYm07CiAgICB2aWRlby94LWZsdiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmx2OwogICAgdmlkZW8veC1tNHYgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG00djsKICAgIHZpZGVvL3gtbW5nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtbmc7CiAgICB2aWRlby94LW1zLWFzZiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN4IGFzZjsKICAgIHZpZGVvL3gtbXMtd212ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3bXY7CiAgICB2aWRlby94LW1zdmlkZW8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZpOwp9Cg==", "mtime": "1970-01-01T00:00:00Z", "name": "mime.types", "size": 2756} ], "name": "/etc/nginx" }, { "files": [ { "contents": "c2VydmVyIHsKICAgIGxpc3RlbiAgICAgICA4MCBkZWZhdWx0X3NlcnZlcjsKICAgIHNlcnZlcl9uYW1lICBsb2NhbGhvc3Q7CgoKICAgIGV4cGlyZXMgLTE7CgogICAgI2FwcF9wcm90ZWN0X2VuYWJsZSBvbjsKCiAgICBzdWJfZmlsdGVyX29uY2Ugb2ZmOwogICAgc3ViX2ZpbHRlciAnc2VydmVyX2hvc3RuYW1lJyAnJGhvc3RuYW1lJzsKICAgIHN1Yl9maWx0ZXIgJ3NlcnZlcl9hZGRyZXNzJyAgJyRzZXJ2ZXJfYWRkcjokc2VydmVyX3BvcnQnOwogICAgc3ViX2ZpbHRlciAnc2VydmVyX3VybCcgICAgICAnJHJlcXVlc3RfdXJpJzsKICAgIHN1Yl9maWx0ZXIgJ3JlbW90ZV9hZGRyJyAgICAgJyRyZW1vdGVfYWRkcjokcmVtb3RlX3BvcnQnOwogICAgc3ViX2ZpbHRlciAnc2VydmVyX2RhdGUnICAgICAnJHRpbWVfbG9jYWwnOwogICAgc3ViX2ZpbHRlciAnY2xpZW50X2Jyb3dzZXInICAnJGh0dHBfdXNlcl9hZ2VudCc7CiAgICBzdWJfZmlsdGVyICdyZXF1ZXN0X2lkJyAgICAgICckcmVxdWVzdF9pZCc7CiAgICBzdWJfZmlsdGVyICduZ2lueF92ZXJzaW9uJyAgICckbmdpbnhfdmVyc2lvbic7CiAgICBzdWJfZmlsdGVyICdkb2N1bWVudF9yb290JyAgICckZG9jdW1lbnRfcm9vdCc7CiAgICBzdWJfZmlsdGVyICdwcm94aWVkX2Zvcl9pcCcgICckaHR0cF94X2ZvcndhcmRlZF9mb3InOwoKICAgIGxvY2F0aW9uIC8gewogICAgICAgIHJvb3QgICAvdXNyL3NoYXJlL25naW54L2h0bWw7CiAgICAgICAgaW5kZXggIGRlbW9faW5kZXguaHRtbCBpbmRleC5odG1sIGluZGV4Lmh0bTsKICAgIH0KCiAgICBlcnJvcl9wYWdlICAgNTAwIDUwMiA1MDMgNTA0ICAvNTB4Lmh0bWw7CiAgICBsb2NhdGlvbiA9IC81MHguaHRtbCB7CiAgICAgICAgcm9vdCAgIC91c3Ivc2hhcmUvbmdpbngvaHRtbDsKICAgIH0KfQo=", "mtime": "1970-01-01T00:00:00Z", "name": "default.conf", "size": 908 } ], "name": "/etc/nginx/conf.d" }], "object_id": "nc_Mw2aZnqkSkyB6g3dR6BdGw" }' -H "Content-Type: application/json"          
